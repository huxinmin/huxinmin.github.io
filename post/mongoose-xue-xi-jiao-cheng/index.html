<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>èƒ¡æ–°æ•çš„ä¸ªäººåšå®¢</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<meta name="description" content="èƒ¡æ–°æ•çš„ä¸ªäººåšå®¢"/>
<meta name="keywords" content="èƒ¡æ–°æ•çš„ä¸ªäººåšå®¢"/>

<!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
<link rel="shortcut icon" href="https://huxinmin.github.io/favicon.ico">

<link rel="stylesheet" href="https://huxinmin.github.io/styles/main.css">

<!-- Modernizr JS -->
<script src="https://huxinmin.github.io/media/scripts/modernizr-2.6.2.min.js"></script>
<!-- FOR IE9 below -->
<!--[if lt IE 9]>
<scripts src="https://huxinmin.github.io/media/scripts/respond.min.js"></scripts>
<![endif]-->

<!-- Comment -->



<!-- katex -->
<!--<link href="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.css" rel="stylesheet">-->

<link href="https://cdn.bootcss.com/font-awesome/5.11.2/css/all.min.css" rel="stylesheet">



</head>
<body>
    <div id="fh5co-offcanvas">
    <a href="#!" class="fh5co-close-offcanvas js-fh5co-close-offcanvas">
        <span><i class="icon-cross3"></i> <span>Close</span></span>
    </a>
    <div class="fh5co-bio">
        <figure>
            <img src="https://huxinmin.github.io/images/avatar.png" alt="èƒ¡æ–°æ•çš„ä¸ªäººåšå®¢"
                 class="img-responsive">
        </figure>
        <a href="https://huxinmin.github.io/post/about/"><h3 class="heading">ABOUT ME</h3></a>
        <h2>èƒ¡æ–°æ•çš„ä¸ªäººåšå®¢</h2>
        <p>èƒ¡æ–°æ•çš„ä¸ªäººåšå®¢</p>
        <ul class="fh5co-social">
            
                <li>
                    
                        <a href="https://github.com/huxinmin" target="_blank">
                            <i class="fab fa-github"></i>
                        </a>
                    
                </li>
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
                <li>
                    
                        <a href="https://www.zhihu.com/people/hu-xin-min-99" target="_blank">
                            <i class="fab fa-zhihu"></i>
                        </a>
                    
                </li>
            
                <li>
                    
                </li>
            
        </ul>
    </div>

    <div class="fh5co-menu">

        <!-- æ ‡ç­¾ -->
        <div class="fh5co-box">
            <a href="https://huxinmin.github.io/tags/"><h3 class="heading">ğŸ‘‰æ ‡ç­¾</h3></a>
            <ul>
                
                    <li><a href="https://huxinmin.github.io/tag/mSeB0wbbH/">linux</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/0CEgc5Nuc/">react</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/AzH6zVqFK/">js</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/UJq-iLfq6/">restful</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/r0zynGCMV/">http</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/GNbObqsVG/">json</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/dZU9srOJ4/">moment.js</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/wsD4ABEPz/">æ•°æ®åº“</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/tq8jF2xcA/">mongoose</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/VL5yScL71/">mongodb</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/XRK7arMJO/">nodejs</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/DJMLUSVfi/">html5</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/oHlYLx_Tl/">websocket</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/8-tAS0eFO/">nginx</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/X3jlBk5nJ/">css</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/H8XsrzQ7e/">css3</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/J27JVlP2F/">æ–‡ä»¶ä¸Šä¼ </a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/X3Z7s8kF_/">jquery</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/CrwH886ky/">ajax</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/s0bxFP3uF/">express</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/38jtWMHZL/">as</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/ZSDYSDwY2/">å…¶ä»–</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/GhuJji1q_/">æµ‹è¯•</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/4OX23_HC0/">jest</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/dlMKptzLv/">ç¼–è¾‘å™¨</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/JavlGTiRY/">editorconfig</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/hK_EE8fK-/">html</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/8ARTmIQjv/">karma</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/Efegfi1Q0/">jasmine</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/tvb1JT8Vl/">mocha</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/9HFOidQXy/">chai</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/siBe4eLq2/">shoudjs</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/82-zkoYE7/">phantomjs</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/Yn33g0TTY/">protracor</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/JEoE22ARw/">scp</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/ZobAApfEI/">æ—¶é—´</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/p-1jKuK3s/">shell</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/o2F0RWP7Z/">expect</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/oZPL-E1ZP/">android</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/J3VGgpXs3/">cordova</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/hMVcUsgPS/">ssh</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/R2oW4iPeR/">travis</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/3v5vwBmB7/">æŒç»­é›†æˆ</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/wal-ORU6g/">debug</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/nDFAAzmpuR/">è°ƒè¯•</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/ev9_gzvje/">eslint</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/ntzw3iLKX/">cè¯­è¨€</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/pTofQIx8N/">å¾…åŠäº‹å®œ</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/8u7cjaUBn/">éšç¬”</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/JxrnYwde_/">rxjs</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/_TCq2VBQY/">ionic</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/ISScirFbw/">hybird</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/I2qOLVgn5/">java</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/l3EUiIS45/">jdk</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/4JSZ2fIFF/">commander</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/KPcAAJVPD/">cli</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/HOjS4qCUx/">npm</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/lqFA57swl/">webpack</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/saP-vOeLO/">flex</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/2w4zWQ1rD/">modernizr</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/ZFB8USksG/">fetch</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/HcGdqo85L/">é¢è¯•</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/maCy0gm-G/">kindle</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/m_CeLo5Yt/">ä¹¦ç±</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/6rUJXYvms/">crontab</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/Sy1VSsLCc/">less</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/rkzXit3IP/">calc</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/02zgiNEsk/">chmod</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/Y3JItHzej/">æ­£åˆ™</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/-rUjtgnqY/">markdown</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/7cRU4Rk01/">shadowsocks</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/Lcnh0Kloq/">rar</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/6LfZ0TlHm/">chrome</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/2_ru1bd6V/">æµè§ˆå™¨</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/v4XDvkty0/">svg-captcha</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/IfZJdWPEH4/">éªŒè¯ç </a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/dTR2pztpH/">github</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/knySerdH-/">git</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/NSyjPJZkv/">aws</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/pU8c2aJR5/">webassembly</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/Y9WXm0Dq5/">csrf</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/qL6pz1TS3V/">ç½‘ç»œå®‰å…¨</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/4iG18Qwl3/">sshd</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/OJtK_Dsle/">certbot</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/IFH5mQ48qH/">https</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/d2mdgi3zW/">sitemap</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/UsaB01y9b/">sublime</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/oVWhBDgSF/">centos</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/Q6D25qRLv/">åŸŸå</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/apvJi9fD0/">linqjs</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/3ZKlDJ0kL/">psftp</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/XATUWlxdty/">æ–‡ä»¶ä¼ è¾“</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/JqHVZntTk/">putty</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/aM2YKZNfZ/">excel</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/75lp1XTT6/">cnpm</a></li>
                
                    <li><a href="https://huxinmin.github.io/tag/eFtdyA4Ic/">åå‘ä»£ç†</a></li>
                
            </ul>
        </div>
    </div>
</div>

<header id="fh5co-header">
    <div class="container-fluid">
        <div class="row">
            <a href="#" class="js-fh5co-nav-toggle fh5co-nav-toggle"><i></i></a>
            <ul class="fh5co-social">
                
                    <li>
                        <a href="/"
                        
                        >
                            é¦–é¡µ
                        </a>
                    </li>
                
                    <li>
                        <a href="/archives"
                        
                        >
                            å½’æ¡£
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags"
                        
                        >
                            æ ‡ç­¾
                        </a>
                    </li>
                
                    <li>
                        <a href="/post/about"
                        
                        >
                            å…³äº
                        </a>
                    </li>
                
            </ul>
            <div class="col-lg-12 col-md-12 text-center">
                <h1 id="fh5co-logo">
                    <a href="https://huxinmin.github.io">èƒ¡æ–°æ•çš„ä¸ªäººåšå®¢ </a>
                </h1>
            </div>
        </div>
    </div>
</header>


    <!--  <a href="#" class="fh5co-post-prev"><span>ğŸ‘ˆ Prev</span></a>-->
    <!--  <a href="#" class="fh5co-post-next"><span>Next ğŸ‘‰</span></a>-->

    <!-- ç­‰grideaå‡ºè‡ªå®šä¹‰é¡µé¢åŠŸèƒ½å†ä¼˜åŒ–ä¸€ä¸‹ -->
    
        <div class="container-fluid">
    <div class="row fh5co-post-entry single-entry">
        <article class="col-lg-8 col-lg-offset-2 col-md-8 col-md-offset-2 col-sm-8 col-sm-offset-2 col-xs-12 col-xs-offset-0">
            <figure class="animate-box">
                
                    <img src="https://huxinmin.github.io/post-images/mongoose-xue-xi-jiao-cheng.png" alt="mongooseå­¦ä¹ æ•™ç¨‹" class="img-responsive">
                
            </figure>
            <span class="fh5co-meta animate-box">
                
                    <div class="tag-container">
                        
                            <a href="https://huxinmin.github.io/tag/wsD4ABEPz/" class="tag">æ•°æ®åº“, </a>
                        
                            <a href="https://huxinmin.github.io/tag/tq8jF2xcA/" class="tag">mongoose, </a>
                        
                            <a href="https://huxinmin.github.io/tag/VL5yScL71/" class="tag">mongodb, </a>
                        
                    </div>
                
            </span>
            <h2 class="fh5co-article-title animate-box">mongooseå­¦ä¹ æ•™ç¨‹</h2>
            <ol class="breadcrumb fh5co-meta fh5co-date animate-box" style="margin-bottom:0; background-color:#f8f9fa">
                <li>2020-04-20</li>
                <li>5130å­—</li>
                <li>25 min read</li>
            </ol>

            <div class="col-lg-12 col-lg-offset-0 col-md-12 col-md-offset-0 col-sm-12 col-sm-offset-0 col-xs-12 col-xs-offset-0 text-left content-article">
                <div class="row">
                    <div class="col-md-12 animate-box post-content">
                        <p> <h2 id="why-mongoose">why mongoose?</h2>
<p>åœ¨å®˜ç½‘ä¸Šæ˜¯è¿™æ ·è¯´çš„ï¼Œæˆ‘ä»¬å¼€å‘Mongooseæ˜¯å› ä¸ºï¼ˆå¼€å‘è€…ï¼‰å†™MongoDBçš„éªŒè¯æœºåˆ¶ã€ç±»å‹è½¬æ¢ä¸ä¸šåŠ¡é€»è¾‘æ¨¡æ¿å¾ˆéº»çƒ¦ã€‚ é’ˆå¯¹ä¸ºåº”ç”¨æ•°æ®å»ºæ¨¡çš„é—®é¢˜ï¼ŒMongoose æä¾›äº†ä¸€å¥—ç›´ç™½çš„ï¼ŒåŸºäºæ¨¡å¼çš„è§£å†³æ–¹æ¡ˆã€‚åŒ…æ‹¬äº†å†…å»ºçš„ç±»å‹è½¬æ¢ã€éªŒè¯å™¨ã€æŸ¥è¯¢æ„é€ å™¨ã€ä¸šåŠ¡é€»è¾‘é’©å­ç­‰ã€‚</p>
<h2 id="ç®€ä»‹">ç®€ä»‹</h2>
<p>mongooseæ˜¯mongoDBçš„ä¸€ä¸ªå¯¹è±¡æ¨¡å‹å·¥å…·ï¼Œæ˜¯åŸºäº<code>node-mongodb-native</code>å¼€å‘çš„mongoDBçš„nodejsé©±åŠ¨ï¼Œå¯ä»¥åœ¨å¼‚æ­¥çš„ç¯å¢ƒä¸‹æ‰§è¡Œã€‚åŒæ—¶å®ƒä¹Ÿæ˜¯é’ˆå¯¹mongoDBæ“ä½œçš„ä¸€ä¸ªå¯¹è±¡æ¨¡å‹åº“ï¼Œå°è£…äº†mongoDBå¯¹æ–‡æ¡£çš„ä¸€äº›å¢åˆ æ”¹æŸ¥ç­‰å¸¸ç”¨æ–¹æ³•ï¼Œè®©nodejsæ“ä½œmongoDBæ•°æ®åº“å˜å¾—æ›´åŠ å®¹æ˜“ã€‚</p>
<h2 id="å®‰è£…">å®‰è£…</h2>
<p>åœ¨å®‰è£…mongooseä¹‹å‰æˆ‘ä»¬éœ€è¦å®‰è£…<code>mongodb</code>å’Œ<code>nodejs</code>ï¼Œç„¶å</p>
<pre><code class="language-sh">npm install mongoose
</code></pre>
<p>ç„¶åå¼€å§‹å»ºç«‹è¿æ¥å¹¶ä½¿ç”¨å³å¯ï¼š</p>
<pre><code class="language-js">var mongoose = require('mongoose');
mongoose.connect('mongodb://user:pass@localhost:port/database',options);
var conn = mongoose.connection;
conn.on('connected', callback); //è¿æ¥æˆåŠŸ
conn.on('disconnected', callback); //æ–­å¼€è¿æ¥
conn.on('connecting', callback); //è¿æ¥ä¸­
conn.on('disconnecting', callback); //æ–­å¼€è¿æ¥ä¸­
conn.on('error', callback); //è¿æ¥å¼‚å¸¸
</code></pre>
<h2 id="schemas">Schemas</h2>
<p>mongooseä¸­çš„schemaå¯¹åº”äºmongodbä¸­çš„collectionï¼Œå¹¶ä¸”å®šä¹‰äº†è¿™ä¸ªæ–‡æ¡£é‡Œé¢çš„æ•°æ®æ¨¡å‹ã€‚</p>
<pre><code class="language-js"> var mongoose = require('mongoose');
  var Schema = mongoose.Schema;
  var blogSchema = new Schema({
    title:  String,
    author: String,
    body:   String,
    comments: [{ body: String, date: Date }],
    date: { type: Date, default: Date.now },
    hidden: Boolean,
    meta: {
      votes: Number,
      favs:  Number
    }
  });
//å¦‚æœæƒ³åœ¨åæœŸåŠ å…¥åˆ«çš„æ•°æ®æ¨¡å‹
blogSchema.add({ name: 'string', color: 'string', price: 'number' });
</code></pre>
<p>åœ¨å®šä¹‰æ•°æ®æ¨¡å‹çš„æ—¶å€™ï¼Œæ‚¨éœ€è¦æŒ‡å®šæ¯ä¸ªå­—æ®µå¯¹åº”çš„æ•°æ®ç±»å‹ï¼Œmongooseæ”¯æŒä»¥ä¸‹è¿™äº›ç±»å‹ï¼š</p>
<ul>
<li><code>String</code></li>
<li><code>Number</code></li>
<li><code>Date</code></li>
<li><code>Buffer</code></li>
<li><code>Boolean</code></li>
<li><code>Mixed</code></li>
<li><code>ObjectId</code></li>
<li><code>Array</code></li>
<li><code>Decimal128</code></li>
<li><code>Map</code></li>
</ul>
<p>æ‚¨å¯ä»¥ç›´æ¥æŒ‡å®šæ•°æ®çš„ç±»å‹ï¼Œè¿˜å¯ä»¥åœ¨æŒ‡å®šç±»å‹çš„åŒæ—¶ï¼Œè®¾ç½®ä¸€äº›é€‰é¡¹ï¼š</p>
<pre><code class="language-js">var schema1 = new Schema({
  test: String
});
var schema2 = new Schema({
  test: { 
     type: String,
     lowercase: true  //è¯¥é€‰é¡¹åªæ”¯æŒstringç±»å‹
  }
});
</code></pre>
<p>å…¬å…±é€‰é¡¹åˆ—è¡¨å¦‚ä¸‹ï¼š</p>
<ul>
<li><code>required</code>æ˜¯å¦æ˜¯å¿…é¡»å¡«å†™çš„</li>
<li><code>default</code>é»˜è®¤å€¼ï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªå€¼æˆ–è€…ä¸€ä¸ªå¸¦è¿”å›å€¼çš„å‡½æ•°</li>
<li><code>select</code>å¸ƒå°”å€¼ï¼Œæ˜¯å¦å¯ç”¨Mongodbçš„<a href="https://docs.mongodb.com/manual/tutorial/project-fields-from-query-results/" target="_blank" rel="nofollow"><code>projection</code></a>åŠŸèƒ½</li>
<li><code>validate</code>å‡½æ•°ï¼Œæ·»åŠ éªŒè¯å™¨</li>
<li><code>get</code>æ·»åŠ getterå‡½æ•°</li>
<li><code>set</code>æ·»åŠ setterå‡½æ•°</li>
<li><code>alias</code>å­—ç¬¦ç±»å‹ï¼Œå®šä¹‰ä¸€ä¸ª<code>virtual</code><br>
åºåˆ—é€‰é¡¹åˆ—è¡¨å¦‚ä¸‹ï¼š</li>
<li><code>index</code>å¸ƒå°”å€¼ï¼Œæ˜¯å¦ä¸ºè¯¥é”®å»ºç«‹<a href="https://docs.mongodb.com/manual/indexes/" target="_blank" rel="nofollow">åºåˆ—</a></li>
<li><code>unique</code>å¸ƒå°”å€¼ï¼Œæ˜¯å¦å»ºè®®<a href="https://docs.mongodb.com/manual/core/index-unique/" target="_blank" rel="nofollow">å”¯ä¸€åºåˆ—</a></li>
<li><code>sparse</code>å¸ƒå°”å€¼ï¼Œæ˜¯å¦å»ºç«‹<a href="https://docs.mongodb.com/manual/core/index-sparse/" target="_blank" rel="nofollow">ç¨€ç–åºåˆ—</a><br>
å­—ç¬¦ä¸²é€‰é¡¹åˆ—è¡¨å¦‚ä¸‹ï¼š</li>
<li><code>lowercase</code>å¸ƒå°”å€¼ï¼Œè½¬æ¢ä¸ºå°å†™</li>
<li><code>uppercase</code>å¸ƒå°”å€¼ï¼Œè½¬æ¢ä¸ºå¤§å†™</li>
<li><code>trim</code>å¸ƒå°”å€¼ï¼Œæ˜¯å¦ä½¿ç”¨<code>trim()</code>æ–¹æ³•æ¶ˆé™¤ç©ºç™½</li>
<li><code>match</code>æ­£åˆ™ï¼Œæ£€æŸ¥æ˜¯å¦åŒ¹é…</li>
<li><code>enum</code>æ•°ç»„ï¼Œæ£€æµ‹æ˜¯å¦åœ¨æ•°ç»„ä¸­</li>
<li><code>minlength</code>æœ€å°é•¿åº¦</li>
<li><code>maxlength</code>æœ€å¤§é•¿åº¦</li>
</ul>
<p>æ³¨æ„çš„ç‚¹ï¼š</p>
<ul>
<li>å†…ç½®çš„jsçš„Dateæ–¹æ³•æ”¹å˜mongooseçš„dateç±»å‹æ•°æ®æ—¶ï¼Œä¿å­˜æ—¶æ— æ•ˆï¼Œå¿…é¡»å…ˆè°ƒç”¨<code>markModified</code>æ–¹æ³•</li>
</ul>
<pre><code class="language-js">var Assignment = mongoose.model('Assignment', { dueDate: Date });
Assignment.findOne(function (err, doc) {
  doc.dueDate.setMonth(3);
  doc.save(callback); // æ— æ•ˆ
  doc.markModified('dueDate');
  doc.save(callback); // æœ‰æ•ˆ
})
</code></pre>
<ul>
<li>mixedç±»å‹çš„æ•°æ®ç±»å‹å¦‚æœå€¼æ”¹å˜ï¼Œä¹Ÿéœ€è¦å…ˆè°ƒç”¨<code>markModified</code>æ–¹æ³•</li>
</ul>
<pre><code class="language-js">person.anything = { x: [3, 4, { y: &quot;changed&quot; }] };
person.markModified('anything');
person.save();
</code></pre>
<ul>
<li>å…·åŒ–ObjectIdçš„æ—¶å€™éœ€è¦ä½¿ç”¨<code>Schema.Types.ObjectId</code></li>
</ul>
<pre><code class="language-js">var ObjectId = mongoose.Schema.Types.ObjectId;
var Car = new Schema({ driver: ObjectId });
</code></pre>
<ul>
<li>mapç±»å‹çš„æ•°æ®éœ€è¦<code>get()</code>å’Œ<code>set()</code>æ¥å–å€¼å’Œè®¾ç½®å€¼</li>
</ul>
<pre><code class="language-js">const user = new User({
  socialMediaHandles: {}
});
user.socialMediaHandles.set('github', 'vkarpov15');
user.set('socialMediaHandles.twitter', '@code_barbarian');
console.log(user.socialMediaHandles.get('github'));
console.log(user.get('socialMediaHandles.twitter'));
</code></pre>
<ul>
<li><code>schema.path()</code>å¯ä»¥è·å¾—å®ä¾‹åŒ–çš„schemaçš„ç±»å‹</li>
</ul>
<pre><code class="language-js">var sampleSchema = new Schema({ name: { type: String, required: true } });
console.log(sampleSchema.path('name'));
// è¾“å‡ºå¦‚ä¸‹:
/**
 * SchemaString {
 *   enumValues: [],
 *   regExp: null,
 *   path: 'name',
 *   instance: 'String',
 *   validators: ...
 */
</code></pre>
<p>æˆ‘ä»¬å¯ä»¥åœ¨schemaä¸Šå®šä¹‰ä¸€äº›<code>methods</code>ï¼Œè¯¥æ–¹æ³•å¯ä»¥åœ¨documentä¸Šä½¿ç”¨(æ³¨æ„ä¸è¦ä½¿ç”¨ç®­å¤´å‡½æ•°ï¼Œå¦åˆ™æ— æ³•è·å–this)</p>
<pre><code class="language-js"> var animalSchema = new Schema({ name: String, type: String });
animalSchema.methods.findSimilarTypes = function(cb) {
    return this.model('Animal').find({ type: this.type }, cb);
};
//æˆ–è€…è¿™æ ·å†™
animalSchema.method('findSimilarTypes ', function () {})
animalSchema.method({findSimilarTypes : function () {}});
//åœ¨Modelä¸Šä½¿ç”¨
var Animal = mongoose.model('Animal', animalSchema);
var dog = new Animal({ type: 'dog' });
dog.findSimilarTypes(function(err, dogs) {
    console.log(dogs); // woof
});
</code></pre>
<p>æˆ‘ä»¬è¿˜å¯ä»¥åœ¨schemaä¸Šå®šä¹‰ä¸€äº›<code>statics</code>ï¼Œè¯¥æ–¹æ³•å¯ä»¥åœ¨modelä¸Šä½¿ç”¨ï¼š</p>
<pre><code class="language-js">animalSchema.statics.findByName = function(name, cb) {
    return this.find({ name: new RegExp(name, 'i') }, cb);
  };
var Animal = mongoose.model('Animal', animalSchema);
  Animal.findByName('fido', function(err, animals) {
    console.log(animals);
  });
</code></pre>
<p>æˆ‘ä»¬è¿˜å¯ä»¥ä¸ºæŸ¥æ‰¾å™¨å¢åŠ ä¸€äº›é“¾å¼å¸®åŠ©å‡½æ•°</p>
<pre><code class="language-js"> animalSchema.query.byName = function(name) {
    return this.where({ name: new RegExp(name, 'i') });
  };
var Animal = mongoose.model('Animal', animalSchema);
  Animal.find().byName('fido').exec(function(err, animals) {
    console.log(animals);
  });
</code></pre>
<p>mongooseé»˜è®¤ä¼šä¸ºæ¯ä¸ªschemaå»ºç«‹ä¸€ä¸ªè‡ªåŠ¨ç´¢å¼•ï¼Œä¸è¿‡åœ¨ç”Ÿäº§ç¯å¢ƒå»ºè®®å…³æ‰ï¼Œæœ‰å¦‚ä¸‹è¿™äº›æ–¹æ³•ï¼š</p>
<pre><code class="language-js"> mongoose.connect('mongodb://user:pass@localhost:port/database', { autoIndex: false });
  mongoose.createConnection('mongodb://user:pass@localhost:port/database', { autoIndex: false });
  animalSchema.set('autoIndex', false);
  new Schema({..}, { autoIndex: false });
</code></pre>
<p>æ‚¨è¿˜å¯ä»¥ä¸ºschemaè®¾ç½®è™šæ‹Ÿçš„å±æ€§ï¼Œè¯¥å±æ€§ä¸ä¼šä¿å­˜åœ¨æ•°æ®åº“ä¸­ï¼Œä½†æ˜¯åœ¨ä½ å–å€¼è®¾ç½®å€¼çš„æ—¶å€™ï¼Œå¯ä»¥åˆ†è§£æˆ–è€…åˆå¹¶å±æ€§å€¼ï¼š</p>
<pre><code class="language-js">var personSchema = new Schema({
    name: {
      first: String,
      last: String
    }
  });
  var Person = mongoose.model('Person', personSchema);
  var axl = new Person({
    name: { first: 'Axl', last: 'Rose' }
  });
personSchema.virtual('fullName').get(function () {
  return this.name.first + ' ' + this.name.last;
});
console.log(axl.fullName); // Axl Rose
</code></pre>
<p>æ³¨æ„è¦å¯¹è™šæ‹Ÿå±æ€§è¿›è¡Œ<code>toJSON()</code> or<code>toObject()</code>è½¬æ¢æ—¶éœ€è¦ä¼ é€’<code>{ virtuals: true }</code>å‚æ•°è¿›æ¥æ‰è¡Œã€‚</p>
<p>ä½ è¿˜å¯ä»¥ä½¿ç”¨<code>alias</code>ä¸ºå±æ€§åè®¾ç½®åˆ«å</p>
<pre><code class="language-js">var personSchema = new Schema({
  n: {
    type: String,
    alias: 'name'
  }
})
var person = new Person({ name: 'Val' });
console.log(person); // { n: 'Val' }
console.log(person.toObject({ virtuals: true })); // { n: 'Val', name: 'Val' }
</code></pre>
<p>æ³¨æ„å¦‚æœæ˜¯åµŒå¥—å±æ€§ï¼Œéœ€è¦è®¾ç½®åµŒå¥—è·¯å¾„</p>
<pre><code class="language-js">const parentSchema = new Schema({
  name: {
    f: {
      type: String,
      alias: 'name.first'
    }
  }
});
</code></pre>
<p>æ‚¨è¿˜å¯ä»¥ä¸ºschemaè®¾ç½®é€‰é¡¹ï¼Œè¯­æ³•å¦‚ä¸‹ï¼š</p>
<pre><code class="language-js">new Schema({..}, options);
//æˆ–è€…
var schema = new Schema({..});
schema.set(option, value);
</code></pre>
<p>å®ƒæœ‰å¦‚ä¸‹è¿™äº›é€‰é¡¹ï¼š</p>
<ul>
<li><code>autoIndex</code>å¸ƒå°”å€¼ï¼Œæ˜¯å¦å¼€å¯è‡ªåŠ¨ç´¢å¼•</li>
<li><code>bufferCommands</code>å¸ƒå°”å€¼ï¼Œå½“è¿æ¥æŒ‚æ‰é‡è¿ä¹‹å‰æ˜¯å¦ç¼“å†²å‘½ä»¤</li>
<li><code>capped</code>æ•°å€¼ï¼Œä½¿ç”¨å›ºå®šå¤§å°collection</li>
<li><code>collection</code>å­—ç¬¦ä¸²ï¼Œä¸ºcollectionè®¾ç½®ä¸åŒçš„åå­—</li>
<li><code>id</code>å¸ƒå°”å€¼ï¼Œå…³é—­é»˜è®¤çš„è™šæ‹Ÿå±æ€§<code>id</code>å€¼ï¼ˆè¿”å›çš„å…¶å®æ˜¯_idï¼‰</li>
<li><code>_id</code>å¸ƒå°”å€¼ï¼Œå…³é—­<code>_id</code>å€¼ï¼ˆå°†ä¼šå¯¼è‡´æ— æ³•ä¿å­˜ï¼‰</li>
<li><code>minimize</code>å¸ƒå°”å€¼ï¼Œè®¾ä¸ºfalseä¼šä¿å­˜ç©ºå¯¹è±¡</li>
<li><code>read</code>è®¾ç½®queryçš„readçš„ä¼˜å…ˆçº§</li>
<li><code>writeConcern</code><a href="https://docs.mongodb.com/manual/reference/write-concern/" target="_blank" rel="nofollow">åœ¨schemaçº§åˆ«è®¾ç½®write concern</a></li>
<li><code>safe</code>é—ç•™apiï¼Œä¸writeConcernç›¸åŒ</li>
<li><code>shardKey</code>è®¾ç½®åˆ†ç‰‡keyå€¼</li>
<li><code>strict</code>å¸ƒå°”å€¼ï¼Œè§„å®šåœ¨schemaä¸­æ²¡æœ‰å®šä¹‰çš„keyä¸ä¼šè¢«ä¿å­˜</li>
<li><code>strictQuery</code>ä¸ºfilterè®¾ç½®query</li>
<li><code>toJSON</code>è½¬æ¢ä¸ºjsonå¯¹è±¡ä¸toObjectç›¸åŒï¼Œä½†æ˜¯éœ€è¦æ˜¾ç¤ºè°ƒç”¨</li>
<li><code>toObject</code>è½¬æ¢ä¸ºJsonå¯¹è±¡</li>
</ul>
<pre><code class="language-js">var schema = new Schema({ name: String });
schema.path('name').get(function (v) {
  return v + ' is my name';
});
schema.set('toJSON', { getters: true, virtuals: false });
var M = mongoose.model('Person', schema);
var m = new M({ name: 'Max Headroom' });
schema.set('toObject', { getters: true });
console.log(m.toJSON());// { _id: 504e0cd7dd992d9be2f20b6f, name: 'Max Headroom is my name' }
console.log(m); // { _id: 504e0cd7dd992d9be2f20b6f, name: 'Max Headroom is my name' }
</code></pre>
<ul>
<li><code>typeKey</code>é»˜è®¤çš„ï¼Œmongooseä¼šå°†<code>type</code>å­—ç¬¦ä¸²å½“åšMongooseçš„typeè§£é‡Šï¼Œå¦‚æœéœ€è¦å½“åšå±æ€§è¿›è¡Œè§£é‡Šï¼Œéœ€è¦è®¾ç½®typeKey</li>
</ul>
<pre><code class="language-js">var schema = new Schema({
  // Mongoose interpets this as 'loc is an object with 2 keys, type and coordinates'
  loc: { type: String, coordinates: [Number] },
  // Mongoose interprets this as 'name is a String'
  name: { $type: String }
}, { typeKey: '$type' }); // A '$type' key means this object is a type declaration
</code></pre>
<ul>
<li>validateBeforeSaveæ‰‹åŠ¨æ§åˆ¶æ˜¯å¦åœ¨ä¿å­˜ä¹‹å‰è¿›è¡ŒéªŒè¯</li>
</ul>
<pre><code class="language-js">var schema = new Schema({ name: String });
schema.set('validateBeforeSave', false);
</code></pre>
<ul>
<li><code>versionKey</code>è‡ªå®šä¹‰ç‰ˆæœ¬æ§åˆ¶</li>
<li><code>collation</code><a href="https://docs.mongodb.com/manual/reference/collation/" target="_blank" rel="nofollow">è®¾ç½®æ ¡éªŒ</a></li>
<li><code>skipVersioning</code>å¿½ç•¥ç‰ˆæœ¬ç®¡ç†</li>
<li><code>timestamps</code>è®¾ç½®æ—¶é—´æˆ³ï¼Œé»˜è®¤ä¸ºcreatedAt å’ŒupdatedAt</li>
<li><code>useNestedStrict</code>è®¾ç½®åµŒå¥—schemaçš„æ›´æ–°è§„åˆ™</li>
</ul>
<h2 id="è¿æ¥">è¿æ¥</h2>
<p>æ‚¨å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„è¯­æ³•æ¥è¿æ¥mongodb:</p>
<pre><code class="language-js">mongoose.connect('mongodb://username:password@host:port/database?options...',options);
</code></pre>
<p>optionsæœ‰ä¸€ä¸‹é€‰é¡¹ï¼š</p>
<ul>
<li><code>bufferCommands</code></li>
<li><code>user/pass</code></li>
<li><code>autoIndex</code></li>
<li><code>dbName</code></li>
<li><code>autoReconnect</code></li>
<li><code>reconnectTries</code></li>
<li><code>reconnectInterval</code></li>
<li><code>promiseLibrary</code></li>
<li><code>poolSize</code></li>
<li><code>bufferMaxEntries</code></li>
<li><code>connectTimeoutMS</code></li>
<li><code>socketTimeoutMS</code></li>
</ul>
<h2 id="models">Models</h2>
<p>Modelsæ˜¯ç”¨æ¥åˆ›å»ºå’Œè¯»å†™æ•°æ®åº“çš„ï¼Œå®ƒçš„ä¸€ä¸ªå®ä¾‹å°±æ˜¯documentã€‚</p>
<pre><code class="language-js">var Tank = mongoose.model('Tank', yourSchema);
//ç¬¬ä¸€ç§æ–¹æ³•
var small = new Tank({ size: 'small' });
small.save(function (err) {
  if (err) return handleError(err);
  // saved!
});
// ç¬¬äºŒç§æ–¹æ³•
Tank.create({ size: 'small' }, function (err, small) {
  if (err) return handleError(err);
  // saved!
});
// ç¬¬ä¸‰ç§æ–¹æ³•
Tank.insertMany([{ size: 'small' }], function(err) {

});
</code></pre>
<p>æ³¨æ„æ¯ä¸€ä¸ªmodeléƒ½æœ‰å¯¹åº”çš„è¿æ¥ï¼Œå¦‚æœä½¿ç”¨çš„æ˜¯<code>mongoose.model()</code>,åˆ™å¯¹åº”<code>mongoose.connect('localhost', 'gettingstarted');</code>å¦‚æœä½¿ç”¨çš„æ˜¯è‡ªå®šä¹‰çš„è¿æ¥ï¼Œåˆ™ä½¿ç”¨</p>
<pre><code class="language-js">var connection = mongoose.createConnection('mongodb://localhost:27017/test');
var Tank = connection.model('Tank', yourSchema);
</code></pre>
<p>å¸¸ç”¨æŸ¥è¯¢æ“ä½œï¼š</p>
<ul>
<li><code>deleteMany()</code></li>
<li><code>deleteOne()</code></li>
<li><code>find()</code></li>
<li><code>findById()</code></li>
<li><code>findByIdAndDelete()</code></li>
<li><code>findByIdAndRemove()</code></li>
<li><code>findByIdAndUpdate()</code></li>
<li><code>findOne()</code></li>
<li><code>findOneAndDelete()</code></li>
<li><code>findOneAndRemove()</code></li>
<li><code>findOneAndUpdate()</code></li>
<li><code>replaceOne()</code></li>
<li><code>updateMany()</code></li>
<li><code>updateOne()</code></li>
</ul>
<p>è¿™äº›æ–¹æ³•éƒ½æœ‰ä¸¤ç§æ–¹æ³•ï¼Œä¸€ç§æ˜¯ç›´æ¥ä½¿ç”¨å›è°ƒå‡½æ•°ï¼Œå¦ä¸€ç§æ˜¯ä½¿ç”¨<code>.then()</code>é“¾å¼è°ƒç”¨ï¼ˆä¸åŒäºçœŸæ­£çš„promiseï¼Œmongooseè¿”å›çš„æŸ¥è¯¢ä¸èƒ½ä½¿ç”¨å¤šæ¬¡thenï¼Œå¦åˆ™ä¼šæ‰§è¡Œå¤šæ¬¡ï¼‰ï¼Œå½“æ•°æ®æ”¹å˜çš„æ—¶å€™ï¼Œæ‚¨è¿˜å¯ä»¥ä½¿ç”¨<code>model.watch</code>æ¥è¿›è¡Œè§‚å¯Ÿï¼š</p>
<pre><code class="language-js">async function run() {
  // Create a new mongoose model
  const personSchema = new mongoose.Schema({
    name: String
  });
  const Person = mongoose.model('Person', personSchema, 'Person');
  // Create a change stream. The 'change' event gets emitted when there's a
  // change in the database
  Person.watch().
    on('change', data =&gt; console.log(new Date(), data));
  // Insert a doc, will trigger the change stream handler above
  console.log(new Date(), 'Inserting doc');
  await Person.create({ name: 'Axl Rose' });
}
2018-05-11T15:05:35.467Z 'Inserting doc'
2018-05-11T15:05:35.487Z 'Inserted doc'
2018-05-11T15:05:35.491Z { _id: { _data: ... },
  operationType: 'insert',
  fullDocument: { _id: 5af5b13fe526027666c6bf83, name: 'Axl Rose', __v: 0 },
  ns: { db: 'test', coll: 'Person' },
  documentKey: { _id: 5af5b13fe526027666c6bf83 } }
</code></pre>
<p>æ‚¨ä¸ä»…å¯ä»¥æŠŠæŸ¥è¯¢çš„æ¡ä»¶ä¸€æ¬¡æ€§å…¨éƒ¨å†™åœ¨æŸ¥è¯¢jsonä¸­ï¼Œè¿˜å¯ä»¥ä½¿ç”¨é“¾å¼æ–¹å¼ä¹¦å†™ï¼Œä¸‹é¢çš„å†™æ³•éƒ½æ˜¯ç›¸ç­‰çš„ï¼š</p>
<pre><code class="language-js">Person.
  find({
    occupation: /host/,
    'name.last': 'Ghost',
    age: { $gt: 17, $lt: 66 },
    likes: { $in: ['vaporizing', 'talking'] }
  }).
  limit(10).
  sort({ occupation: -1 }).
  select({ name: 1, occupation: 1 }).
  exec(callback);
// ç›¸ç­‰çš„å†™æ³•
Person.
  find({ occupation: /host/ }).
  where('name.last').equals('Ghost').
  where('age').gt(17).lt(66).
  where('likes').in(['vaporizing', 'talking']).
  limit(10).
  sort('-occupation').
  select('name occupation').
  exec(callback);
</code></pre>
<p>æ‚¨è¿˜å¯ä»¥ä¸ºæŸ¥è¯¢æ–¹æ³•è®¾ç½®ä¸€äº›é’©å­å‡½æ•°ï¼Œä½¿ç”¨<code>cursor()</code>å³å¯ï¼Œæœ‰ä¸¤ç§æ–¹æ³•ï¼Œç¬¬ä¸€ç§ä½¿ç”¨streamè°ƒç”¨ï¼Œç¬¬äºŒç§ä½¿ç”¨<code>next</code>æ‰‹åŠ¨è°ƒç”¨ï¼š</p>
<pre><code class="language-js">// There are 2 ways to use a cursor. First, as a stream:
Thing.
  find({ name: /^hello/ }).
  cursor().
  on('data', function(doc) { console.log(doc); }).
  on('end', function() { console.log('Done!'); });
// Or you can use `.next()` to manually get the next doc in the stream.
// `.next()` returns a promise, so you can use promises or callbacks.
var cursor = Thing.find({ name: /^hello/ }).cursor();
cursor.next(function(error, doc) {
  console.log(doc);
});
</code></pre>
<h2 id="subdocuments">subdocuments</h2>
<p>documentsä»£è¡¨å­˜å‚¨åœ¨mongodbä¸­çš„å®é™…æ•°æ®ï¼Œæ¯ä¸€ä¸ªdocumentéƒ½æ˜¯modelçš„ä¸€ä¸ªå®ä¾‹ã€‚subdocumentså°±æ˜¯åµŒå¥—åœ¨å…¶ä»–documentsä¸­çš„å­æ–‡æ¡£ã€‚mongooseä¸­æœ‰ä¸¤ç§å­æ–‡æ¡£ç±»å‹ï¼Œä¸€ç§æ˜¯æ•°ç»„ï¼Œä¸€ç§æ˜¯å•ä¸ªæ–‡æ¡£ï¼š</p>
<pre><code class="language-js">var parentSchema = new Schema({
  // Array of subdocuments
  children: [childSchema],
  // Single nested subdocuments. Caveat: single nested subdocs only work
  // in mongoose &gt;= 4.2.0
  child: childSchema
});
</code></pre>
<p>subdocumentså’Œdocumentsä¹‹é—´çš„ä¸»è¦ä¸åŒå°±æ˜¯ï¼Œsubdocumentsä¸å•ç‹¬ä¿å­˜ï¼Œåªè¦çˆ¶çº§documentsä¿å­˜äº†ï¼Œå®ƒå°±ä¼šè¢«ä¿å­˜ã€‚å­æ–‡æ¡£çš„<code>pre('save')</code>å’Œ<code>pre('validate')</code>ä¼šåœ¨çˆ¶æ–‡æ¡£çš„<code>pre('save')</code>ä¹‹å‰ï¼Œ<code>pre('validate')</code>ä¹‹åæ‰§è¡Œã€‚æ‚¨å¯ä»¥ä½¿ç”¨<code>_id</code>æŸ¥æ‰¾å­æ–‡æ¡£ï¼š</p>
<pre><code class="language-js">var doc = parent.children.id(_id);
</code></pre>
<p>æ‚¨å¯ä»¥ä½¿ç”¨pushï¼Œunshiftï¼ŒaddToSetæ¥å¯¹å­æ–‡æ¡£æ•°ç»„æ“ä½œï¼Œæˆ–è€…ç›´æ¥ä½¿ç”¨createæ–¹æ³•ï¼š</p>
<pre><code class="language-js">var Parent = mongoose.model('Parent');
var parent = new Parent;
// create a comment
parent.children.push({ name: 'Liesl' });
var subdoc = parent.children[0];
console.log(subdoc) // { _id: '501d86090d371bab2c0341c5', name: 'Liesl' }
subdoc.isNew; // true
parent.save(function (err) {
  if (err) return handleError(err)
  console.log('Success!');
});
//æˆ–è€…
var newdoc = parent.children.create({ name: 'Aaron' });
</code></pre>
<p>å½“æ‚¨æƒ³è¦åˆ é™¤å­æ–‡æ¡£æ—¶ï¼Œå¯ä»¥ä½¿ç”¨<code>remove</code>æ–¹æ³•ï¼š</p>
<pre><code class="language-js">// Equivalent to `parent.children.pull(_id)`
parent.children.id(_id).remove();
// Equivalent to `parent.child = null`
parent.child.remove();
</code></pre>
<h2 id="éªŒè¯">éªŒè¯</h2>
<p>åœ¨mongooseä¸­ï¼Œæ•°æ®çš„æ¯æ¬¡æ“ä½œéƒ½éœ€è¦è¿›è¡ŒéªŒè¯ï¼Œè¿™æ ·å°±å¯ä»¥é˜²æ­¢ä¸€äº›æ¶æ„æ³¨å…¥ç­‰å±å®³ã€‚éªŒè¯æ˜¯åœ¨schemaä¸­å®šä¹‰çš„ï¼Œä¸”æ˜¯middlewareã€‚</p>
<p>Mongooseä¸­æœ‰ä¸€äº›å†…ç½®çš„éªŒè¯å™¨ï¼š</p>
<ul>
<li><code>required</code></li>
<li><code>Numbers</code>æœ‰<code>min</code>å’Œ<code>max</code>éªŒè¯å™¨</li>
<li><code>Strings</code>æœ‰<code>enum</code>, <code>match</code>, <code>maxlength</code> and <code>minlength</code>éªŒè¯å™¨</li>
</ul>
<p>å¦‚æœæƒ³è¦è‡ªå®šä¹‰ä½ è‡ªå·±çš„éªŒè¯å™¨ï¼Œå¯ä»¥åŠ å…¥<code>validate</code>å±æ€§ï¼š</p>
<pre><code class="language-js">var userSchema = new Schema({
  phone: {
    type: String,
    validate: {
      validator: function(v) {
        return /\d{3}-\d{3}-\d{4}/.test(v);
      },
      message: '{VALUE} is not a valid phone number!'
    },
    required: [true, 'User phone number required']
  }
});
var User = db.model('user', userSchema);
var user = new User();
var error;
user.phone = '555.0123';
error = user.validateSync();
assert.equal(error.errors['phone'].message,
  '555.0123 is not a valid phone number!');
</code></pre>
<p>æ‚¨è¿˜æœ‰å¯ä»¥è®¾ç½®å¼‚æ­¥çš„éªŒè¯å™¨ï¼š</p>
<pre><code class="language-js">var userSchema = new Schema({
  name: {
    type: String,
    // You can also make a validator async by returning a promise. If you
    // return a promise, do **not** specify the `isAsync` option.
    validate: function(v) {
      return new Promise(function(resolve, reject) {
        setTimeout(function() {
          resolve(false);
        }, 5);
      });
    }
  },
  phone: {
    type: String,
    validate: {
      isAsync: true,
      validator: function(v, cb) {
        setTimeout(function() {
          var phoneRegex = /\d{3}-\d{3}-\d{4}/;
          var msg = v + ' is not a valid phone number!';
          // First argument is a boolean, whether validator succeeded
          // 2nd argument is an optional error message override
          cb(phoneRegex.test(v), msg);
        }, 5);
      },
      // Default error message, overridden by 2nd argument to `cb()` above
      message: 'Default error message'
    },
    required: [true, 'User phone number required']
  }
});
</code></pre>
<p>å¦‚æœæƒ³è¦åœ¨<code>update()</code>æˆ–è€…<code>findOneAndUpdate()</code>ä¸­å¼€å¯éªŒè¯çš„è¯ï¼Œéœ€è¦è®¾ç½®<code>runValidators</code>:</p>
<pre><code class="language-js">var toySchema = new Schema({
  color: String,
  name: String
});
var Toy = db.model('Toys', toySchema);
Toy.schema.path('color').validate(function (value) {
  return /blue|green|white|red|orange|periwinkle/i.test(value);
}, 'Invalid color');
var opts = { runValidators: true };
Toy.update({}, { color: 'bacon' }, opts, function (err) {
  assert.equal(err.errors.color.message,
    'Invalid color');
});
</code></pre>
<p><code>update</code>éªŒè¯å™¨å’Œ<code>document</code>éªŒè¯å™¨æœ‰å‡ ç‚¹åŒºåˆ«ï¼š</p>
<ul>
<li>updateéªŒè¯å™¨thisæœªå®šä¹‰,documentéªŒè¯å™¨thisæŒ‡å‘è¯¥documentï¼Œä¸è¿‡ä½ å¯ä»¥åœ¨updateéªŒè¯å™¨ä¸Šé€šè¿‡è®¾ç½®contextè®¾ç½®thisæŒ‡å‘è¯¥æŸ¥è¯¢</li>
<li>updateéªŒè¯å™¨åªéªŒè¯å¯¹åº”çš„è·¯å¾„</li>
<li>updateéªŒè¯å™¨åªåœ¨ä¸€äº›æ“ä½œç¬¦æ—¶å€™è¿è¡Œï¼Œ<code>$set</code>ï¼Œ<code>$unset</code>ï¼Œ<code>$push (&gt;= 4.8.0)</code>ï¼Œ<code>$addToSet (&gt;= 4.8.0)</code>ï¼Œ<code>$pull (&gt;= 4.12.0)</code>ï¼Œ<code>$pullAll (&gt;= 4.12.0)</code></li>
</ul>
<h2 id="middleware">Middleware</h2>
<p>Mongooseæœ‰4ç§ä¸­é—´ä»¶ï¼š</p>
<ul>
<li>document ä¸­é—´ä»¶ï¼š
<ul>
<li><code>init</code></li>
<li><code>validate</code></li>
<li><code>save</code></li>
<li><code>remove</code></li>
</ul>
</li>
<li>model ä¸­é—´ä»¶ï¼š
<ul>
<li><code>count</code></li>
<li><code>find</code></li>
<li><code>findOne</code></li>
<li><code>findOneAndRemove</code></li>
<li><code>findOneAndUpdate</code></li>
<li><code>update</code></li>
<li><code>updateOne</code></li>
<li><code>updateMany</code></li>
</ul>
</li>
<li><code>aggregate</code> ä¸­é—´ä»¶ï¼š
<ul>
<li><code>aggregate</code></li>
</ul>
</li>
<li><code>query</code> ä¸­é—´ä»¶ï¼š
<ul>
<li><code>insertMany</code></li>
</ul>
</li>
</ul>
<p>æœ‰ä¸¤ç§é’©å­å‡½æ•°ï¼Œä¸€ç§æ˜¯ä¸²è¡Œçš„ï¼Œä¸€ç§æ˜¯å¹¶è¡Œçš„ï¼Œåœ¨ä¸²è¡Œä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨<code>next</code>æ¥æ‰§è¡Œä¸‹ä¸€æ­¥ï¼Œæˆ–è€…è¿”å›ä¸€ä¸ªpromiseå‡½æ•°ï¼Œpreè¡¨ç¤ºä¹‹å‰ï¼Œpostè¡¨ç¤ºä¹‹åï¼š</p>
<pre><code class="language-js">var schema = new Schema(..);
schema.pre('save', function(next) {
  // do stuff
  next();
});
schema.pre('save', function() {
  return doStuff().
    then(() =&gt; doMoreStuff());
});
// Or, in Node.js &gt;= 7.6.0:
schema.pre('save', async function() {
  await doStuff();
  await doMoreStuff();
});
</code></pre>
<p>å¹¶è¡Œçš„æä¾›äº†æ›´åŠ ç»†ç²’åº¦çš„æµæ§åˆ¶ï¼š</p>
<pre><code class="language-js">var schema = new Schema(..);
// ç¬¬äºŒä¸ªå‚æ•°è®¾ç½®ä¸ºtrueè¡¨ç¤ºå¹¶è¡Œ
schema.pre('save', true, function(next, done) {
  // calling next kicks off the next middleware in parallel
  next();
  setTimeout(done, 100);
});
</code></pre>
<p>æ³¨æ„postå’Œpreä¸ä¼šåœ¨update(), findOneAndUpdate()ä¸Šæ‰§è¡Œã€‚</p>
<h2 id="populate">Populate</h2>
<p>populationæ˜¯ä¸€ä¸ªè‡ªåŠ¨æŠŠdocumentä¸­çš„è·¯å¾„è½¬æ¢ä¸ºå¯¹åº”çš„documentçš„è¿‡ç¨‹ï¼Œä½¿ç”¨<code>ref</code>æŒ‡å‘å³å¯ï¼š</p>
<pre><code class="language-js">var mongoose = require('mongoose');
var Schema = mongoose.Schema;
var personSchema = Schema({
  _id: Schema.Types.ObjectId,
  name: String,
  age: Number,
  stories: [{ type: Schema.Types.ObjectId, ref: 'Story' }]
});
var storySchema = Schema({
  author: { type: Schema.Types.ObjectId, ref: 'Person' },
  title: String,
  fans: [{ type: Schema.Types.ObjectId, ref: 'Person' }]
});
var Story = mongoose.model('Story', storySchema);
var Person = mongoose.model('Person', personSchema);
</code></pre>
<p>æ³¨æ„ObjectId, Number, String, and Bufferéƒ½æ˜¯åˆæ³•çš„refç±»å‹ï¼Œä½†æ˜¯å¯¹äºæ–°æ‰‹æœ€å¥½åªä½¿ç”¨ObjectIdã€‚</p>
<p>ç„¶ååœ¨æŸ¥è¯¢çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥<code>populate</code>å°†å¯¹åº”çš„æ•°æ®æ•´åˆè¿›æ¥ï¼š</p>
<pre><code class="language-js">Story.
  findOne({ title: 'Casino Royale' }).
  populate('author').
  exec(function (err, story) {
    if (err) return handleError(err);
    console.log('The author is %s', story.author.name);
    // prints &quot;The author is Ian Fleming&quot;
  });
</code></pre>
<p>å¦‚æœåªæƒ³æ•´åˆä¸€äº›åŸŸçš„è¯ï¼Œå¯ä»¥åœ¨populateçš„ç¬¬äºŒä¸ªå‚æ•°ä¸­å†™å…¥è¦é€‰æ‹©çš„å­—æ®µï¼Œå¦‚æœæ˜¯å¤šä¸ªçš„è¯å¯ä»¥ç”¨ç©ºæ ¼åˆ†å¼€ï¼š</p>
<pre><code class="language-js">Story.
  findOne({ title: /casino royale/i }).
  populate('author', 'name'). // only return the Persons name
  exec(function (err, story) {})
</code></pre>
<p>å¦‚æœæƒ³è¦æ•´åˆå¤šä¸ªrefçš„è¯ï¼Œå¯ä»¥è¿ç»­è°ƒç”¨(å¦‚æœå¯¹åŒä¸€ä¸ªrefè®¾ç½®å¤šä¸ªï¼Œåˆ™åªæœ‰æœ€åä¸€ä¸ªç”Ÿæ•ˆ)</p>
<pre><code class="language-js">Story.
  find(...).
  populate('fans').
  populate('author').
  exec();
</code></pre>
<p>å¦‚æœæƒ³è¦æ›´ç²¾ç»†åŒ–çš„æ§åˆ¶ï¼Œè¿˜å¯ä»¥ç»™populateä¼ å…¥ä¸€ä¸ªå¯¹è±¡ï¼š</p>
<pre><code class="language-js">Story.
  find(...).
  populate({
    path: 'fans',
    match: { age: { $gte: 21 }},
    // Explicitly exclude `_id`, see http://bit.ly/2aEfTdB
    select: 'name -_id',
    options: { limit: 5 }
  }).
  exec();
</code></pre>
<p>å¦‚æœä½ æƒ³è¦populateæ–‡æ¡£ä¸‹é¢çš„populateå¯¹è±¡ï¼Œåˆ™ï¼š</p>
<pre><code class="language-js">User.
  findOne({ name: 'Val' }).
  populate({
    path: 'friends',
    // Get friends of friends - populate the 'friends' array for every friend
    populate: { path: 'friends' }
  });
</code></pre>
<p>è·¨æ•°æ®åº“populate:</p>
<pre><code class="language-js">var eventSchema = new Schema({
  name: String,
  // The id of the corresponding conversation
  // Notice there's no ref here!
  conversation: ObjectId
});
var conversationSchema = new Schema({
  numMessages: Number
});
var db1 = mongoose.createConnection('localhost:27000/db1');
var db2 = mongoose.createConnection('localhost:27001/db2');
var Event = db1.model('Event', eventSchema);
var Conversation = db2.model('Conversation', conversationSchema);
Event.
  find().
  populate({ path: 'conversation', model: Conversation }).
  exec(function(error, docs) { /* ... */ });
</code></pre>
<p>æ‚¨è¿˜å¯ä»¥é€šè¿‡è®¾ç½®<code>refPath</code>æ¥è®¾ç½®åŠ¨æ€çš„ref:</p>
<pre><code class="language-js">var userSchema = new Schema({
  name: String,
  connections: [{
    kind: String,
    item: { type: ObjectId, refPath: 'connections.kind' }
  }]
});
</code></pre>
<p>åªåœ¨_idä¸­è®¾ç½®refä¸æ˜¯æœ€å¥½çš„é€‰æ‹©ï¼Œæ‚¨è¿˜å¯ä»¥åœ¨virtualsä¸­è¿›è¡Œè®¾ç½®ï¼š</p>
<pre><code class="language-js">var PersonSchema = new Schema({
  name: String,
  band: String
});
var BandSchema = new Schema({
  name: String
});
BandSchema.virtual('members', {
  ref: 'Person', // The model to use
  localField: 'name', // æ‰¾åˆ°æœ¬åœ°å­—æ®µ `localField`ä¸å¯¹åº”modelå­—æ®µ`foreignField`å€¼ç›¸ç­‰çš„document
  foreignField: 'band', 
  // If `justOne` is true, 'members' will be a single doc as opposed to
  // an array. `justOne` is false by default.
  justOne: false
});
</code></pre>
<p>æ³¨æ„<code>toJSON()</code>ä¸åŒ…å«åœ¨virtuals ä¸­ï¼Œæ‰€ä»¥éœ€è¦æ‰‹åŠ¨è®¾ç½®ï¼š</p>
<pre><code class="language-js">var BandSchema = new Schema({
  name: String
}, { toJSON: { virtuals: true } });
</code></pre>
<p>ç„¶åä½¿ç”¨,æ³¨æ„<code>foreignField</code>å¿…é¡»åŒ…å«åœ¨populateä¸­ï¼š</p>
<pre><code class="language-js">Band.
  find({}).
  populate({ path: 'members', select: 'name band' }).
  exec(function(error, bands) {
    // Works, foreign field `band` is selected
  });
</code></pre>
<p>æ‚¨è¿˜å¯ä»¥åœ¨ä¸­é—´ä»¶ä¸­ä½¿ç”¨populate:</p>
<pre><code class="language-js">MySchema.pre('find', function() {
  this.populate('user');
});
MySchema.post('find', async function(docs) {
  for (let doc of docs) {
    if (doc.isPublic) {
      await doc.populate('user').execPopulate();
    }
  }
});
MySchema.post('save', function(doc, next) {
  doc.populate('user').execPopulate(function() {
    next();
  });
});
</code></pre>
<h2 id="discriminators">Discriminators</h2>
<p>Discriminators æ˜¯ä¸€ä¸ªschemaçš„ç»§æ‰¿æœºåˆ¶ï¼Œå¯ä»¥ä½¿å¾—ä½ æ‹¥æœ‰å¤šä¸ªmodelsä½¿ç”¨äº†é‡å çš„schemaåœ¨åŒä¸€ä¸ªcollectionä¸‹é¢ã€‚ä¾‹å¦‚ä½ å¯ä»¥ä½¿ç”¨<code>model.discriminator()</code>æ¥æ•´åˆä¸€ä¸ªåŸºç¡€çš„schemaå’Œä¸€ä¸ªDiscriminator schemaï¼š</p>
<pre><code class="language-js">var options = {discriminatorKey: 'kind'};
var eventSchema = new mongoose.Schema({time: Date}, options);
var Event = mongoose.model('Event', eventSchema);
// ClickedLinkEvent is a special type of Event that has
// a URL.
var ClickedLinkEvent = Event.discriminator('ClickedLink',
  new mongoose.Schema({url: String}, options));
// When you create a generic event, it can't have a URL field...
var genericEvent = new Event({time: Date.now(), url: 'google.com'});
assert.ok(!genericEvent.url);
// But a ClickedLinkEvent can
var clickedEvent =
  new ClickedLinkEvent({time: Date.now(), url: 'google.com'});
</code></pre>
<p>mongooseåˆ†è¾¨ä¸åŒçš„Discriminators æ˜¯é€šè¿‡<code>__t</code>æ¥åŒºåˆ†çš„ï¼Œè€Œä¸”Discriminators éƒ½å¯ä»¥å¾ˆæ™ºèƒ½åœ°é€šè¿‡<code>find()</code>, <code>count()</code>, <code>aggregate()</code>æ¥æ‰¾åˆ°æ•°é‡ï¼š</p>
<pre><code class="language-js">var event1 = new Event({time: Date.now()});
var event2 = new ClickedLinkEvent({time: Date.now(), url: 'google.com'});
var event3 = new SignedUpEvent({time: Date.now(), user: 'testuser'});
var save = function (doc, callback) {
  doc.save(function (error, doc) {
    callback(error, doc);
  });
};
async.map([event1, event2, event3], save, function (error) {
  ClickedLinkEvent.find({}, function (error, docs) {
    assert.equal(docs.length, 1);
    assert.equal(docs[0]._id.toString(), event2._id.toString());
    assert.equal(docs[0].url, 'google.com');
  });
});
</code></pre>
<p>Discriminators å¯ä»¥ä½¿ç”¨åŸºç¡€çš„schemaçš„ä¸­é—´ä»¶ï¼Œä½†æ˜¯ä½ ä¹Ÿå¯ä»¥ä¸ºå®ƒæ·»åŠ è‡ªå·±çš„ä¸­é—´ä»¶è€Œä¸å½±å“åŸºç¡€çš„schema:</p>
<pre><code class="language-js">var options = {discriminatorKey: 'kind'};
var eventSchema = new mongoose.Schema({time: Date}, options);
var eventSchemaCalls = 0;
eventSchema.pre('validate', function (next) {
  ++eventSchemaCalls;
  next();
});
var Event = mongoose.model('GenericEvent', eventSchema);
var clickedLinkSchema = new mongoose.Schema({url: String}, options);
var clickedSchemaCalls = 0;
clickedLinkSchema.pre('validate', function (next) {
  ++clickedSchemaCalls;
  next();
});
var ClickedLinkEvent = Event.discriminator('ClickedLinkEvent',
  clickedLinkSchema);
var event1 = new ClickedLinkEvent();
event1.validate(function() {
  assert.equal(eventSchemaCalls, 1);
  assert.equal(clickedSchemaCalls, 1);
  var generic = new Event();
  generic.validate(function() {
    assert.equal(eventSchemaCalls, 2);
    assert.equal(clickedSchemaCalls, 1);
  });
});
</code></pre>
<p>å½“ä½ ä½¿ç”¨<code>Model.create()</code>è‡ªåŠ¨åˆ›å»ºæ—¶ï¼Œmongooseä¼šè‡ªåŠ¨ä¸ºæ‚¨é€‰æ‹©é€‚åˆçš„Discriminatorè¿›è¡Œåˆ›å»ºï¼š</p>
<pre><code class="language-js">var Schema = mongoose.Schema;
var shapeSchema = new Schema({
  name: String
}, { discriminatorKey: 'kind' });
var Shape = db.model('Shape', shapeSchema);
var Circle = Shape.discriminator('Circle',
  new Schema({ radius: Number }));
var Square = Shape.discriminator('Square',
  new Schema({ side: Number }));
var shapes = [
  { name: 'Test' },
  { kind: 'Circle', radius: 5 },
  { kind: 'Square', side: 10 }
];
Shape.create(shapes, function(error, shapes) {
  assert.ifError(error);
  assert.ok(shapes[0] instanceof Shape);
  assert.ok(shapes[1] instanceof Circle);
  assert.equal(shapes[1].radius, 5);
  assert.ok(shapes[2] instanceof Square);
  assert.equal(shapes[2].side, 10);
});
</code></pre>
<h2 id="å¸¸ç”¨api">å¸¸ç”¨API</h2>
<ul>
<li>
<p>Model</p>
<ul>
<li><code>Model.count()</code>æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æ–‡æ¡£æ•°é‡ï¼Œå·²ç»åºŸå¼ƒ</li>
<li><code>Model.countDocuments()</code>æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æ–‡æ¡£æ•°é‡</li>
<li><code>Model.create()</code>åˆ›å»ºä¸€ä¸ªæˆ–å¤šä¸ªæ–‡æ¡£ï¼Œ<code>MyModel.create(docs)</code>ç­‰åŒäºå¤šä¸ª<code>new MyModel(doc).save()</code></li>
<li><code>Model.deleteMany()</code>åˆ é™¤å¤šä¸ª</li>
<li><code>Model.deleteOne()</code>åˆ é™¤ä¸€ä¸ª</li>
<li><code>Model.distinct()</code>æŸ¥æ‰¾æ‰€æœ‰æ–‡æ¡£ä¸­æŸä¸ªå­—æ®µçš„ä¸é‡å¤å€¼ï¼Œè¿”å›å»é‡åçš„å­—æ®µæ‰€æœ‰å€¼</li>
<li><code>Model.find()</code></li>
<li><code>Model.findById()</code></li>
<li><code>Model.findByIdAndDelete()</code></li>
<li><code>Model.findByIdAndRemove()</code></li>
<li><code>Model.findByIdAndUpdate()</code></li>
<li><code>Model.findOne()</code></li>
<li><code>Model.findOneAndDelete()</code></li>
<li><code>Model.findOneAndRemove()</code></li>
<li><code>Model.findOneAndUpdate()</code></li>
<li><code>Model.insertMany()</code></li>
<li><code>Model.populate()</code></li>
<li><code>Model.prototype.$where()</code>åˆ›å»ºä¸€ä¸ªæŸ¥è¯¢</li>
</ul>
<pre><code class="language-js">Blog.$where('this.username.indexOf(&quot;val&quot;) !== -1').exec();
</code></pre>
<ul>
<li><code>Model.prototype.remove()</code></li>
<li><code>Model.prototype.save()</code></li>
<li><code>Model.remove()</code></li>
<li><code>Model.replaceOne()</code></li>
<li><code>Model.update()</code>æ›´æ–°æ–‡æ¡£ä½†æ˜¯ä¸è¿”å›è¯¥æ•°æ®</li>
<li><code>Model.updateMany()</code></li>
<li><code>Model.updateOne()</code></li>
<li><code>Model.where()</code>æŸ¥è¯¢</li>
</ul>
<pre><code class="language-js">User.where('age').gte(21).lte(65).exec(callback);
</code></pre>
</li>
<li>
<p>Document</p>
<ul>
<li><code>Document.prototype.$ignore()</code>ä¸å…è®¸éªŒè¯å™¨ï¼Œä¸ä¿ç•™æ”¹åŠ¨æŸä¸ªå­—æ®µ</li>
<li><code>Document.prototype.$isDefault()</code>åˆ¤æ–­æŸä¸ªå­—æ®µæ˜¯å¦è®¾ç½®é»˜è®¤å€¼</li>
<li><code>Document.prototype.$isDeleted()</code>åˆ¤æ–­æ˜¯å¦ç§»é™¤</li>
<li><code>Document.prototype.depopulate()</code>è¿›è¡Œpopulateçš„é€†è¿ç®—</li>
<li><code>Document.prototype.get()</code>å–å€¼</li>
<li><code>Document.prototype.invalidate()</code>å°†å­—æ®µæ ‡è®°ä¸ºä¸åˆæ ¼ï¼Œè§¦å‘éªŒè¯å¤±è´¥</li>
<li><code>Document.prototype.populate()</code>æ•´åˆref</li>
<li><code>Document.prototype.populated()</code>è¿”å›æ•´åˆçš„refçš„<code>_id</code></li>
<li><code>Document.prototype.save()</code>ä¿å­˜</li>
<li><code>Document.prototype.set()</code>è®¾ç½®å€¼</li>
<li><code>Document.prototype.toJSON()</code>è½¬æ¢ä¸ºjson</li>
<li><code>Document.prototype.toObject()</code>è½¬æ¢ä¸ºplainObject</li>
<li><code>Document.prototype.update()</code>æ›´æ–°æ–‡æ¡£</li>
<li><code>Document.prototype.validate()</code>æ‰§è¡ŒéªŒè¯å™¨</li>
<li><code>Document.prototype.validateSync()</code>åŒæ­¥æ‰§è¡ŒéªŒè¯å™¨</li>
</ul>
</li>
<li>
<p>Query</p>
<ul>
<li><code>Query.prototype.$where()</code>æ‰§è¡Œä¸€ä¸ªå‡½æ•°æˆ–è¡¨è¾¾å¼æŸ¥è¯¢</li>
</ul>
</li>
</ul>
<pre><code class="language-js">query.$where('this.comments.length === 10 || this.name.length === 5')
// or
query.$where(function () {
  return this.comments.length === 10 || this.name.length === 5;
})
</code></pre>
<ul>
<li><code>Query.prototype.countDocuments()</code>æŸ¥è¯¢æ•°é‡</li>
<li><code>Query.prototype.deleteMany()</code></li>
<li><code>Query.prototype.deleteOne()</code></li>
<li><code>Query.prototype.distinct()</code></li>
<li><code>Query.prototype.elemMatch()</code>åµŒå¥—æŸ¥è¯¢ä½¿ç”¨ï¼Œæ›¿ä»£findæŸ¥è¯¢åµŒå¥—å­—æ®µå†™<code>path.path</code></li>
<li><code>Query.prototype.equals()</code>æŸ¥è¯¢æ—¶å€™å€¼ç­‰äº</li>
<li><code>Query.prototype.exec()</code>æ‰§è¡ŒæŸ¥è¯¢</li>
<li><code>Query.prototype.exists()</code>åˆ¤æ–­æ˜¯å¦å­˜åœ¨æŸä¸ªå­—æ®µ</li>
<li><code>Query.prototype.find()</code></li>
<li><code>Query.prototype.findOne()</code></li>
<li><code>Query.prototype.findOneAndDelete()</code></li>
<li><code>Query.prototype.findOneAndRemove()</code></li>
<li><code>Query.prototype.findOneAndUpdate()</code></li>
<li><code>Query.prototype.getQuery()</code>è¿”å›æŸ¥è¯¢æ¡ä»¶ï¼Œä½¿ç”¨jsonæ ¼å¼è¡¨ç¤ºå‡ºæ¥</li>
<li><code>Query.prototype.getUpdate()</code>è¿”å›æ›´æ–°æ¡ä»¶ï¼Œä½¿ç”¨jsonæ ¼å¼è¡¨ç¤º</li>
<li><code>Query.prototype.gt()</code></li>
<li><code>Query.prototype.gte()</code></li>
<li><code>Query.prototype.lean()</code>æŸ¥è¯¢åçš„ç»“æœå¦‚æœä½¿ç”¨äº†leanå°†ä¸å†æœ‰saveç­‰docçš„æ–¹æ³•</li>
<li><code>Query.prototype.limit()</code></li>
<li><code>Query.prototype.lt()</code></li>
<li><code>Query.prototype.lte()</code></li>
<li><code>Query.prototype.nor()</code>éƒ½ä¸æ˜¯</li>
</ul>
<pre><code class="language-js">query.nor([{ color: 'green' }, { status: 'ok' }])
</code></pre>
<ul>
<li><code>Query.prototype.or()</code>ä¸¤ä¸ªä¸­ä¸€ä¸ª</li>
</ul>
<pre><code class="language-js">query.or([{ color: 'red' }, { status: 'emergency' }])
</code></pre>
<ul>
<li><code>Query.prototype.populate()</code></li>
<li><code>Query.prototype.regex()</code>æ­£åˆ™æŸ¥è¯¢</li>
<li><code>Query.prototype.remove()</code></li>
<li><code>Query.prototype.select()</code>é€‰æ‹©éœ€è¦å±•ç¤ºæˆ–è€…æ’é™¤çš„å­—æ®µï¼Œå¦‚æœæ˜¯å­—ç¬¦å¯ä»¥ç”¨<code>+</code>è¡¨ç¤ºåŒ…å«ï¼Œ<code>-</code>è¡¨ç¤ºæ’é™¤ï¼Œå¯¹è±¡å¯ä»¥ç”¨<code>1</code>è¡¨ç¤ºåŒ…å«ï¼Œ<code>0</code>è¡¨ç¤ºæ’é™¤</li>
</ul>
<pre><code class="language-js">query.select('a b');
query.select('-c -d');
query.select({ a: 1, b: 1 });
query.select({ c: 0, d: 0 });
</code></pre>
<ul>
<li><code>Query.prototype.set()</code></li>
<li><code>Query.prototype.setOptions()</code></li>
<li><code>Query.prototype.skip()</code></li>
<li><code>Query.prototype.slice()</code></li>
<li><code>Query.prototype.sort()</code>æ’åºï¼Œå½“ä½ ä½¿ç”¨objectæ—¶ï¼Œå¯ä»¥æŒ‡å®š<code>asc</code>, <code>desc</code>, <code>ascending</code>, <code>descending</code>, <code>1</code>, and <code>-1</code>ï¼Œå¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œé»˜è®¤æ˜¯å‡åºï¼Œä½¿ç”¨<code>-</code>æ¥é™åºï¼š</li>
</ul>
<pre><code class="language-js">// sort by &quot;field&quot; ascending and &quot;test&quot; descending
query.sort({ field: 'asc', test: -1 });
// equivalent
query.sort('field -test');
</code></pre>
<ul>
<li><code>Query.prototype.then()</code></li>
<li><code>Query.prototype.update()</code></li>
<li><code>Query.prototype.updateMany()</code></li>
<li><code>Query.prototype.updateOne()</code></li>
<li><code>Query.prototype.where()</code></li>
</ul>
<h2 id="å®ä¾‹">å®ä¾‹</h2>
<p>åˆ†é¡µï¼š</p>
<pre><code class="language-js">model.find(queryCondition).limit(limit).skip(limit*page).exec(function(err, results){
      ...
    });
</code></pre>
<h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2>
<ul>
<li><a href="http://mongoosejs.com/docs/" target="_blank" rel="nofollow">http://mongoosejs.com/docs/</a></li>
</ul>
 </p>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12 animate-box">
                        
                            <div class="next-post">
                                <div class="next">ä¸‹ä¸€ç¯‡</div>
                                <a href="https://huxinmin.github.io/post/consolelog-ge-shi-hua-shu-chu-xiang-jie/">
                                    <h3 class="post-title">
                                        console.log æ ¼å¼åŒ–è¾“å‡ºè¯¦è§£
                                    </h3>
                                </a>
                            </div>
                        
                    </div>
                </div>

                <div class="row">
    <div class="col-md-12 animate-box">
        
    </div>
</div>

            </div>

        </article>
    </div>
</div>

    

    <!-- è¿”å›é¡¶éƒ¨ -->
    <div class="back-to-top">
    
        <a href="#!" id="tool-toc" class="hidden-xs hidden-sm">
            <i class="fa fa-map"></i>
        </a>
        <br>
    
    <a href="#top" class="hidden-xs hidden-sm"><i class="fa fa-paper-plane"></i></a>
</div>

<div class="post-toc animated fadeInRight hidden-xs hidden-sm" style="display: none;">
    <ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#why-mongoose">why mongoose?</a></li>
<li><a href="#%E7%AE%80%E4%BB%8B">ç®€ä»‹</a></li>
<li><a href="#%E5%AE%89%E8%A3%85">å®‰è£…</a></li>
<li><a href="#schemas">Schemas</a></li>
<li><a href="#%E8%BF%9E%E6%8E%A5">è¿æ¥</a></li>
<li><a href="#models">Models</a></li>
<li><a href="#subdocuments">subdocuments</a></li>
<li><a href="#%E9%AA%8C%E8%AF%81">éªŒè¯</a></li>
<li><a href="#middleware">Middleware</a></li>
<li><a href="#populate">Populate</a></li>
<li><a href="#discriminators">Discriminators</a></li>
<li><a href="#%E5%B8%B8%E7%94%A8api">å¸¸ç”¨API</a></li>
<li><a href="#%E5%AE%9E%E4%BE%8B">å®ä¾‹</a></li>
<li><a href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">å‚è€ƒèµ„æ–™</a></li>
</ul>
</li>
</ul>

</div>


    
<footer id="fh5co-footer">
  <p>Powered by <a href="https://huxinmin.github.io" target="_blank">èƒ¡æ–°æ•çš„ä¸ªäººåšå®¢</a></p>
</footer>


    <!-- jQuery -->
<script src="https://huxinmin.github.io/media/scripts/jquery.min.js"></script>
<!-- img lazy load -->
<script src="https://huxinmin.github.io/media/scripts/jquery.lazyload.min.js"></script>
<!-- jQuery Easing -->
<script src="https://huxinmin.github.io/media/scripts/jquery.easing.1.3.js"></script>
<!-- Bootstrap -->
<script src="https://huxinmin.github.io/media/scripts/bootstrap.min.js"></script>
<!-- Waypoints -->
<script src="https://huxinmin.github.io/media/scripts/jquery.waypoints.min.js"></script>
<!-- Main JS -->
<script src="https://huxinmin.github.io/media/scripts/main.js"></script>
<!-- Md5 Min JS -->
<script src="https://huxinmin.github.io/media/scripts/md5.min.js"></script>
<!-- katex -->
<!--<script src="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.js"></script>-->
<!-- highlight -->
<script src="https://cdn.bootcss.com/highlight.js/9.15.8/highlight.min.js"></script>


<script type="application/javascript">
    // ä»£ç é«˜äº®
    hljs.initHighlightingOnLoad();

    // img æ‡’åŠ è½½
    $(function () {
        $("img.lazy").lazyload({
            effect: "fadeIn",  // æ‡’åŠ è½½åŠ¨ç”»
            threshold: 180  // åœ¨å›¾ç‰‡è·ç¦»å±å¹•180pxæ—¶æå‰è½½å…¥
        });
        // tooltip
        $('[data-toggle="tooltip"]').tooltip();

        // ç›®å½•
        $('#tool-toc').click(function () {
            $('.post-toc').toggle();
        });
    });

    
        var allImg = $("img");
        allImg.on("contextmenu", function () {
            return false;
        });
        allImg.on("dragstart", function () {
            return false;
        });
    
</script>




</body>
</html>
